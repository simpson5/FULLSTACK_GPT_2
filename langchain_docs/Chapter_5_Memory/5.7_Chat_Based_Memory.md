# ğŸ’¬ Section 5.7: Chat Based Memory - ë©”ì‹œì§€ ê¸°ë°˜ ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ

## ğŸ¯ í•™ìŠµ ëª©í‘œ
- âœ… return_messages=Trueë¥¼ í†µí•œ ë©”ì‹œì§€ ê°ì²´ ë°˜í™˜ ì´í•´
- âœ… ChatPromptTemplateê³¼ MessagesPlaceholder í™œìš©
- âœ… ë™ì  ë©”ì‹œì§€ ìˆ˜ë¥¼ ì²˜ë¦¬í•˜ëŠ” í”Œë ˆì´ìŠ¤í™€ë” ì‹œìŠ¤í…œ
- âœ… ë¬¸ìì—´ ê¸°ë°˜ vs ë©”ì‹œì§€ ê¸°ë°˜ ë©”ëª¨ë¦¬ì˜ ì°¨ì´ì  íŒŒì•…

## ğŸ§  í•µì‹¬ ê°œë…

### Chat Based Memoryë€?
**Chat Based Memory**ëŠ” ë©”ëª¨ë¦¬ ë‚´ìš©ì„ **ë¬¸ìì—´ì´ ì•„ë‹Œ ë©”ì‹œì§€ ê°ì²´**ë¡œ ë°˜í™˜í•˜ì—¬ êµ¬ì¡°í™”ëœ ëŒ€í™”ë¥¼ ì§€ì›í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

```mermaid
graph TD
    A[ì‚¬ìš©ì ì…ë ¥] --> B{ë©”ëª¨ë¦¬ íƒ€ì…}
    B -->|return_messages=False| C[ë¬¸ìì—´ í˜•íƒœ]
    B -->|return_messages=True| D[ë©”ì‹œì§€ ê°ì²´ë“¤]
    
    C --> E[PromptTemplate<br/>ë¬¸ìì—´ ê¸°ë°˜]
    D --> F[ChatPromptTemplate<br/>ë©”ì‹œì§€ ê¸°ë°˜]
    
    E --> G[ë‹¨ìˆœ í…ìŠ¤íŠ¸ ì‚½ì…]
    F --> H[MessagesPlaceholder<br/>ë™ì  ë©”ì‹œì§€ ë°°ì¹˜]
    
    G --> I[LLM]
    H --> I
    I --> J[ì‘ë‹µ]
    
    style D fill:#E6F3FF,stroke:#0066CC,stroke-width:2px
    style F fill:#E6F3FF,stroke:#0066CC,stroke-width:2px
    style H fill:#FFE6CC,stroke:#FF9500,stroke-width:2px
```

### ë¬¸ìì—´ vs ë©”ì‹œì§€ ê¸°ë°˜ ë©”ëª¨ë¦¬ ë¹„êµ

```mermaid
graph LR
    subgraph "ë¬¸ìì—´ ê¸°ë°˜ (return_messages=False)"
        A[Memory] --> B["Human: ì•ˆë…•í•˜ì„¸ìš”\\nAI: ì•ˆë…•í•˜ì„¸ìš”!\\nHuman: ì´ë¦„ì´ ë­ì£ ?"]
        B --> C[PromptTemplate]
        C --> D["í…œí”Œë¦¿: {history}\\nì§ˆë¬¸: {question}"]
    end
    
    subgraph "ë©”ì‹œì§€ ê¸°ë°˜ (return_messages=True)"
        E[Memory] --> F["[HumanMessage('ì•ˆë…•í•˜ì„¸ìš”'),\\n AIMessage('ì•ˆë…•í•˜ì„¸ìš”!'),\\n HumanMessage('ì´ë¦„ì´ ë­ì£ ?')]"]
        F --> G[ChatPromptTemplate]
        G --> H["MessagesPlaceholder\\në™ì  ë©”ì‹œì§€ ë°°ì¹˜"]
    end
    
    style F fill:#E6F3FF,stroke:#0066CC,stroke-width:2px
    style H fill:#FFE6CC,stroke:#FF9500,stroke-width:2px
```

**í•µì‹¬ ì°¨ì´ì **:
- **ë¬¸ìì—´**: ëª¨ë“  ëŒ€í™”ë¥¼ í•˜ë‚˜ì˜ í…ìŠ¤íŠ¸ë¡œ ë³‘í•©
- **ë©”ì‹œì§€**: ê° ë°œí™”ë¥¼ ê°œë³„ ë©”ì‹œì§€ ê°ì²´ë¡œ ìœ ì§€
- **êµ¬ì¡°í™”**: ë©”ì‹œì§€ ê¸°ë°˜ì´ ë” êµ¬ì¡°í™”ëœ ì²˜ë¦¬ ê°€ëŠ¥
- **í”Œë ˆì´ìŠ¤í™€ë”**: ë™ì  ë©”ì‹œì§€ ìˆ˜ ì²˜ë¦¬

## ğŸ“‹ ì£¼ìš” í´ë˜ìŠ¤/í•¨ìˆ˜ ë ˆí¼ëŸ°ìŠ¤

### ChatPromptTemplate í´ë˜ìŠ¤
```python
from langchain.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain.schema import HumanMessage, AIMessage, SystemMessage

class ChatPromptTemplate:
    def from_messages(
        self,
        messages: List[Union[BaseMessage, Tuple, str]]  # ğŸ“Œ ìš©ë„: ë©”ì‹œì§€ í…œí”Œë¦¿ êµ¬ì„±
    ):
        """
        ğŸ“‹ ê¸°ëŠ¥: ë©”ì‹œì§€ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ìƒì„±
        ğŸ“¥ ì…ë ¥: ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ (ì‹œìŠ¤í…œ, ì‚¬ìš©ì, AI ë©”ì‹œì§€)
        ğŸ“¤ ì¶œë ¥: ChatPromptTemplate ì¸ìŠ¤í„´ìŠ¤
        ğŸ’¡ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤: êµ¬ì¡°í™”ëœ ëŒ€í™” ì‹œìŠ¤í…œ
        ğŸ”— ê´€ë ¨ ê°œë…: Message Objects, Chat Completion
        """
```

### MessagesPlaceholder í´ë˜ìŠ¤
```python
class MessagesPlaceholder:
    def __init__(
        self,
        variable_name: str,                  # ğŸ“Œ ìš©ë„: ë³€ìˆ˜ ì´ë¦„ ì§€ì •, íƒ€ì…: Required
        optional: bool = False               # ğŸ“Œ ìš©ë„: ì„ íƒì  í”Œë ˆì´ìŠ¤í™€ë” ì—¬ë¶€
    ):
        """
        ğŸ“‹ ê¸°ëŠ¥: ë™ì  ë©”ì‹œì§€ ìˆ˜ë¥¼ ì²˜ë¦¬í•˜ëŠ” í”Œë ˆì´ìŠ¤í™€ë”
        ğŸ“¥ ì…ë ¥: ë³€ìˆ˜ ì´ë¦„ê³¼ ì˜µì…˜ ì„¤ì •
        ğŸ“¤ ì¶œë ¥: MessagesPlaceholder ì¸ìŠ¤í„´ìŠ¤
        ğŸ’¡ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤: ê°€ë³€ ê¸¸ì´ ëŒ€í™” íˆìŠ¤í† ë¦¬
        ğŸ”— ê´€ë ¨ ê°œë…: Dynamic Templates, Variable Message Lists
        """
```

### ë©”ì‹œì§€ íƒ€ì…ë“¤
```python
# ê¸°ë³¸ ë©”ì‹œì§€ íƒ€ì…ë“¤
HumanMessage(content: str)               # ğŸ“Œ ìš©ë„: ì‚¬ìš©ì ë©”ì‹œì§€
AIMessage(content: str)                  # ğŸ“Œ ìš©ë„: AI ì‘ë‹µ ë©”ì‹œì§€
SystemMessage(content: str)              # ğŸ“Œ ìš©ë„: ì‹œìŠ¤í…œ ì§€ì‹œì‚¬í•­
```

## ğŸ”§ ë™ì‘ ê³¼ì • ìƒì„¸

### 1. ë¬¸ìì—´ ê¸°ë°˜ ë©”ëª¨ë¦¬ (ê¸°ë³¸ ë™ì‘)
```python
# === Step 1: ê¸°ë³¸ ë¬¸ìì—´ ë©”ëª¨ë¦¬ ë™ì‘ í™•ì¸ ===
from langchain.memory import ConversationSummaryBufferMemory
from langchain.chat_models import ChatOpenAI

# LLM ì„¤ì •
llm = ChatOpenAI(temperature=0.3, model="gpt-3.5-turbo")

# ê¸°ë³¸ ë©”ëª¨ë¦¬ (return_messages=False)
string_memory = ConversationSummaryBufferMemory(
    llm=llm,
    max_token_limit=150,
    return_messages=False,  # ğŸ“Œ ê¸°ë³¸ê°’: ë¬¸ìì—´ë¡œ ë°˜í™˜
    memory_key="history"
)

# ëŒ€í™” ì¶”ê°€
string_memory.save_context(
    {"input": "ì•ˆë…•í•˜ì„¸ìš”, ì œ ì´ë¦„ì€ ê¹€ì² ìˆ˜ì…ë‹ˆë‹¤."},
    {"output": "ì•ˆë…•í•˜ì„¸ìš” ê¹€ì² ìˆ˜ë‹˜! ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤."}
)

string_memory.save_context(
    {"input": "ì €ëŠ” ê°œë°œìë¡œ ì¼í•˜ê³  ìˆì–´ìš”."},
    {"output": "ê°œë°œìì‹œëŠ”êµ°ìš”! ì–´ë–¤ ë¶„ì•¼ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•˜ì‹œë‚˜ìš”?"}
)

# ë©”ëª¨ë¦¬ ë‚´ìš© í™•ì¸
print("=== ë¬¸ìì—´ ê¸°ë°˜ ë©”ëª¨ë¦¬ ì¶œë ¥ ===")
memory_content = string_memory.load_memory_variables({})
print(f"íƒ€ì…: {type(memory_content['history'])}")
print(f"ë‚´ìš©:\n{memory_content['history']}")

# ì¶œë ¥ ì˜ˆì‹œ:
# íƒ€ì…: <class 'str'>
# ë‚´ìš©:
# Human: ì•ˆë…•í•˜ì„¸ìš”, ì œ ì´ë¦„ì€ ê¹€ì² ìˆ˜ì…ë‹ˆë‹¤.
# AI: ì•ˆë…•í•˜ì„¸ìš” ê¹€ì² ìˆ˜ë‹˜! ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤.
# Human: ì €ëŠ” ê°œë°œìë¡œ ì¼í•˜ê³  ìˆì–´ìš”.
# AI: ê°œë°œìì‹œëŠ”êµ°ìš”! ì–´ë–¤ ë¶„ì•¼ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•˜ì‹œë‚˜ìš”?
```

### 2. ë©”ì‹œì§€ ê¸°ë°˜ ë©”ëª¨ë¦¬ë¡œ ì „í™˜
```python
# === Step 2: ë©”ì‹œì§€ ê¸°ë°˜ ë©”ëª¨ë¦¬ë¡œ ë³€ê²½ ===

# return_messages=Trueë¡œ ë³€ê²½
message_memory = ConversationSummaryBufferMemory(
    llm=llm,
    max_token_limit=150,
    return_messages=True,  # ğŸ“Œ í•µì‹¬: ë©”ì‹œì§€ ê°ì²´ë¡œ ë°˜í™˜
    memory_key="chat_history"  # ğŸ“Œ ë³€ìˆ˜ëª… ë³€ê²½ (êµ¬ë¶„ì„ ìœ„í•´)
)

# ê°™ì€ ëŒ€í™” ì¶”ê°€
message_memory.save_context(
    {"input": "ì•ˆë…•í•˜ì„¸ìš”, ì œ ì´ë¦„ì€ ê¹€ì² ìˆ˜ì…ë‹ˆë‹¤."},
    {"output": "ì•ˆë…•í•˜ì„¸ìš” ê¹€ì² ìˆ˜ë‹˜! ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤."}
)

message_memory.save_context(
    {"input": "ì €ëŠ” ê°œë°œìë¡œ ì¼í•˜ê³  ìˆì–´ìš”."},
    {"output": "ê°œë°œìì‹œëŠ”êµ°ìš”! ì–´ë–¤ ë¶„ì•¼ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•˜ì‹œë‚˜ìš”?"}
)

# ë©”ëª¨ë¦¬ ë‚´ìš© í™•ì¸
print("=== ë©”ì‹œì§€ ê¸°ë°˜ ë©”ëª¨ë¦¬ ì¶œë ¥ ===")
message_content = message_memory.load_memory_variables({})
print(f"íƒ€ì…: {type(message_content['chat_history'])}")
print(f"ë©”ì‹œì§€ ìˆ˜: {len(message_content['chat_history'])}")

for i, msg in enumerate(message_content['chat_history']):
    print(f"{i+1}. {type(msg).__name__}: {msg.content}")

# ì¶œë ¥ ì˜ˆì‹œ:
# íƒ€ì…: <class 'list'>
# ë©”ì‹œì§€ ìˆ˜: 4
# 1. HumanMessage: ì•ˆë…•í•˜ì„¸ìš”, ì œ ì´ë¦„ì€ ê¹€ì² ìˆ˜ì…ë‹ˆë‹¤.
# 2. AIMessage: ì•ˆë…•í•˜ì„¸ìš” ê¹€ì² ìˆ˜ë‹˜! ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤.
# 3. HumanMessage: ì €ëŠ” ê°œë°œìë¡œ ì¼í•˜ê³  ìˆì–´ìš”.
# 4. AIMessage: ê°œë°œìì‹œëŠ”êµ°ìš”! ì–´ë–¤ ë¶„ì•¼ë¥¼ ì „ë¬¸ìœ¼ë¡œ í•˜ì‹œë‚˜ìš”?
```

### 3. ChatPromptTemplateê³¼ MessagesPlaceholder êµ¬ì„±
```python
# === Step 3: ë©”ì‹œì§€ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ êµ¬ì„± ===
from langchain.prompts import ChatPromptTemplate, MessagesPlaceholder

# ë¬¸ìì—´ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ (ì´ì „ ë°©ì‹)
old_prompt = PromptTemplate(
    input_variables=["history", "question"],
    template="""ë‹¹ì‹ ì€ ë„ì›€ì´ ë˜ëŠ” AIì…ë‹ˆë‹¤.

ëŒ€í™” ê¸°ë¡:
{history}

ì‚¬ìš©ì: {question}
AI:"""
)

print("=== ì´ì „ ë°©ì‹: ë¬¸ìì—´ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ ===")
print("í”„ë¡¬í”„íŠ¸ ë³€ìˆ˜:", old_prompt.input_variables)
print("í…œí”Œë¦¿ êµ¬ì¡°: ê³ ì •ëœ ë¬¸ìì—´ ê¸°ë°˜")

# ìƒˆë¡œìš´ ë°©ì‹: ë©”ì‹œì§€ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸
chat_prompt = ChatPromptTemplate.from_messages([
    ("system", "ë‹¹ì‹ ì€ ë„ì›€ì´ ë˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ì‚¬ìš©ìì™€ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”í•´ì£¼ì„¸ìš”."),
    
    # ğŸ“Œ í•µì‹¬: MessagesPlaceholder - ë™ì  ë©”ì‹œì§€ ì²˜ë¦¬
    MessagesPlaceholder(variable_name="chat_history"),  # ê°€ë³€ ê¸¸ì´ ë©”ì‹œì§€ë“¤
    
    ("human", "{question}")  # í˜„ì¬ ì§ˆë¬¸
])

print("\n=== ìƒˆë¡œìš´ ë°©ì‹: ë©”ì‹œì§€ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ ===")
print("í”„ë¡¬í”„íŠ¸ êµ¬ì¡°: ë©”ì‹œì§€ ê°ì²´ ê¸°ë°˜")
print("í”Œë ˆì´ìŠ¤í™€ë” ë³€ìˆ˜: chat_history")
print("ë™ì  ë©”ì‹œì§€ ì²˜ë¦¬: ê°€ëŠ¥")

# === Step 4: MessagesPlaceholder ì‘ë™ ì›ë¦¬ ìƒì„¸ ===
def demonstrate_messages_placeholder():
    """MessagesPlaceholderì˜ ë™ì‘ ì›ë¦¬ ì‹œì—°"""
    
    print("\n=== MessagesPlaceholder ì‘ë™ ì›ë¦¬ ===")
    
    # ìƒ˜í”Œ ë©”ì‹œì§€ë“¤ (ì‹¤ì œ ë©”ëª¨ë¦¬ì—ì„œ ê°€ì ¸ì˜¨ ê²ƒê³¼ ê°™ì€ í˜•íƒœ)
    from langchain.schema import HumanMessage, AIMessage, SystemMessage
    
    sample_messages = [
        HumanMessage(content="ì•ˆë…•í•˜ì„¸ìš”!"),
        AIMessage(content="ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–»ê²Œ ë„ì™€ë“œë¦´ê¹Œìš”?"),
        HumanMessage(content="ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì–´ë•Œìš”?"),
        AIMessage(content="ì£„ì†¡í•˜ì§€ë§Œ ì‹¤ì‹œê°„ ë‚ ì”¨ ì •ë³´ëŠ” í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    ]
    
    # í”„ë¡¬í”„íŠ¸ í¬ë§·íŒ… ê³¼ì • ì‹œì—°
    formatted_prompt = chat_prompt.format_messages(
        chat_history=sample_messages,  # ğŸ“Œ ë™ì ìœ¼ë¡œ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ ì‚½ì…
        question="ì œê°€ ì´ì „ì— ë­ë¼ê³  ë§í–ˆì£ ?"
    )
    
    print("í¬ë§·íŒ…ëœ ë©”ì‹œì§€ êµ¬ì¡°:")
    for i, msg in enumerate(formatted_prompt):
        print(f"{i+1}. {type(msg).__name__}: {msg.content}")
    
    print(f"\nì´ ë©”ì‹œì§€ ìˆ˜: {len(formatted_prompt)}")
    print("êµ¬ì¡°: SystemMessage + ë™ì  ë©”ì‹œì§€ë“¤ + HumanMessage")

demonstrate_messages_placeholder()
```

### 4. ì™„ì „í•œ ë©”ì‹œì§€ ê¸°ë°˜ ì²´ì¸ êµ¬ì„±
```python
# === Step 5: ì™„ì „í•œ ë©”ì‹œì§€ ê¸°ë°˜ ì²´ì¸ ì‹œìŠ¤í…œ ===
from langchain.chains import LLMChain

def create_message_based_chain():
    """ì™„ì „í•œ ë©”ì‹œì§€ ê¸°ë°˜ ì²´ì¸ ìƒì„± ë° í…ŒìŠ¤íŠ¸"""
    
    print("=== ì™„ì „í•œ ë©”ì‹œì§€ ê¸°ë°˜ ì²´ì¸ êµ¬ì„± ===")
    
    # ë©”ì‹œì§€ ê¸°ë°˜ ë©”ëª¨ë¦¬
    memory = ConversationSummaryBufferMemory(
        llm=llm,
        max_token_limit=200,
        return_messages=True,  # ğŸ“Œ í•µì‹¬ ì„¤ì •
        memory_key="chat_history"
    )
    
    # ë©”ì‹œì§€ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸
    prompt = ChatPromptTemplate.from_messages([
        ("system", """ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. 
        ì‚¬ìš©ìì˜ ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì¼ê´€ì„± ìˆê³  ë„ì›€ì´ ë˜ëŠ” ì‘ë‹µì„ ì œê³µí•´ì£¼ì„¸ìš”.
        
        ëŒ€í™” ìŠ¤íƒ€ì¼:
        - ì¹œê·¼í•˜ë˜ ì „ë¬¸ì ìœ¼ë¡œ
        - ì´ì „ ì •ë³´ë¥¼ ì ì ˆíˆ ì°¸ì¡°
        - êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ë‹µë³€"""),
        
        MessagesPlaceholder(variable_name="chat_history"),  # ğŸ“Œ ë™ì  ë©”ì‹œì§€ ë°°ì¹˜
        ("human", "{question}")
    ])
    
    # LLMChain êµ¬ì„±
    chain = LLMChain(
        llm=llm,
        prompt=prompt,
        memory=memory,
        verbose=True  # ë©”ì‹œì§€ êµ¬ì¡° í™•ì¸ìš©
    )
    
    return chain

# ì²´ì¸ ìƒì„± ë° í…ŒìŠ¤íŠ¸
message_chain = create_message_based_chain()

# === Step 6: ëŒ€í™” í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ===
conversation_scenarios = [
    "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì ë°•ë¯¼ìˆ˜ë¼ê³  í•©ë‹ˆë‹¤.",
    "Reactì™€ TypeScriptë¡œ ê°œë°œí•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•´ìš”.",
    "ìš”ì¦˜ Next.js 14ë¥¼ ê³µë¶€í•˜ê³  ìˆëŠ”ë°, ê¶ê¸ˆí•œ ê²Œ ìˆì–´ìš”.",
    "ì•ì„œ ì œê°€ ì–´ë–¤ ê¸°ìˆ ë“¤ì„ ì–¸ê¸‰í–ˆëŠ”ì§€ ê¸°ì–µí•˜ì‹œë‚˜ìš”?",
    "ê·¸ë¦¬ê³  ì œ ì´ë¦„ë„ ê¸°ì–µí•˜ì‹œë‚˜ìš”?"
]

print("\n" + "="*60)
print("ğŸ¯ ë©”ì‹œì§€ ê¸°ë°˜ ë©”ëª¨ë¦¬ ëŒ€í™” í…ŒìŠ¤íŠ¸")
print("="*60)

for i, scenario in enumerate(conversation_scenarios, 1):
    print(f"\nã€ëŒ€í™” {i}ã€‘")
    print(f"ğŸ‘¤ ì‚¬ìš©ì: {scenario}")
    
    try:
        response = message_chain.predict(question=scenario)
        print(f"ğŸ¤– AI: {response}")
        
        # ì¤‘ê°„ ë©”ëª¨ë¦¬ ìƒíƒœ í™•ì¸ (2, 4ë²ˆì§¸ ëŒ€í™” í›„)
        if i in [2, 4]:
            memory_state = message_chain.memory.load_memory_variables({})
            print(f"\nğŸ“Š í˜„ì¬ ë©”ëª¨ë¦¬ ìƒíƒœ (ë©”ì‹œì§€ ìˆ˜: {len(memory_state['chat_history'])}):")
            
            for j, msg in enumerate(memory_state['chat_history'][-4:]):  # ìµœê·¼ 4ê°œë§Œ í‘œì‹œ
                msg_type = type(msg).__name__.replace('Message', '')
                print(f"   {j+1}. {msg_type}: {msg.content[:50]}...")
                
    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜ ë°œìƒ: {e}")

print("\n" + "="*60)
```

## ğŸ’» ì‹¤ì „ ì˜ˆì œ

### ê³ ê¸‰ ë©€í‹°ëª¨ë‹¬ ì±—ë´‡ ì‹œìŠ¤í…œ
```python
from langchain.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain.memory import ConversationSummaryBufferMemory
from langchain.chat_models import ChatOpenAI
from langchain.schema import HumanMessage, AIMessage, SystemMessage
from datetime import datetime
from typing import List, Dict, Any
import json

class AdvancedMessageBasedChatbot:
    """
    ğŸ¯ ëª©ì : ê³ ê¸‰ ë©”ì‹œì§€ ê¸°ë°˜ ì±—ë´‡ ì‹œìŠ¤í…œ
    ğŸ’¡ íŠ¹ì§•: ì»¨í…ìŠ¤íŠ¸ ì¸ì‹, í˜ë¥´ì†Œë‚˜ ì ì‘, ê°ì • ë¶„ì„
    """
    
    def __init__(self, persona: str = "professional"):
        self.llm = ChatOpenAI(temperature=0.4, model="gpt-3.5-turbo")
        self.persona = persona
        self.conversation_count = 0
        
        # í˜ë¥´ì†Œë‚˜ë³„ ì‹œìŠ¤í…œ ë©”ì‹œì§€
        self.personas = {
            "professional": """ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
            - ì •ì¤‘í•˜ê³  ê²©ì‹ ìˆëŠ” í†¤ ìœ ì§€
            - êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì¡°ì–¸ ì œê³µ
            - ë¹„ì¦ˆë‹ˆìŠ¤ ë§¥ë½ì—ì„œ ë‹µë³€""",
            
            "friendly": """ë‹¹ì‹ ì€ ì¹œê·¼í•œ ì¼ìƒ ëŒ€í™” íŒŒíŠ¸ë„ˆì…ë‹ˆë‹¤.
            - í¸ì•ˆí•˜ê³  ì¹œê·¼í•œ í†¤ ì‚¬ìš©
            - ê³µê°ê³¼ ê²©ë ¤ í‘œí˜„
            - ê°œì¸ì  ê²½í—˜ ê³µìœ  ê°€ëŠ¥""",
            
            "educational": """ë‹¹ì‹ ì€ êµìœ¡ ì „ë¬¸ ë©˜í† ì…ë‹ˆë‹¤.
            - í•™ìŠµì ì¤‘ì‹¬ì˜ ì„¤ëª… ë°©ì‹
            - ë‹¨ê³„ì ì´ê³  ì²´ê³„ì ì¸ ê°€ë¥´ì¹¨
            - ì§ˆë¬¸ì„ í†µí•œ ì´í•´ë„ í™•ì¸"""
        }
        
        # ë©”ëª¨ë¦¬ ì´ˆê¸°í™”
        self.memory = ConversationSummaryBufferMemory(
            llm=self.llm,
            max_token_limit=400,
            return_messages=True,  # ğŸ“Œ ë©”ì‹œì§€ ê°ì²´ë¡œ ê´€ë¦¬
            memory_key="conversation_history"
        )
        
        # ê°ì • ìƒíƒœ ë©”ëª¨ë¦¬ (ë³„ë„)
        self.emotion_memory = ConversationSummaryBufferMemory(
            llm=self.llm,
            max_token_limit=200,
            return_messages=True,
            memory_key="emotion_context"
        )
        
        # ë™ì  í”„ë¡¬í”„íŠ¸ ìƒì„±
        self.setup_dynamic_prompt()
    
    def setup_dynamic_prompt(self):
        """í˜ë¥´ì†Œë‚˜ì— ë”°ë¥¸ ë™ì  í”„ë¡¬í”„íŠ¸ ì„¤ì •"""
        
        system_message = f"""{self.personas[self.persona]}

í˜„ì¬ ì‹œê°„: {{current_time}}
ëŒ€í™” íšŸìˆ˜: {{conversation_count}}

ë‹¤ìŒ ì§€ì¹¨ì„ ë”°ë¼ ì‘ë‹µí•´ì£¼ì„¸ìš”:
1. ì´ì „ ëŒ€í™” ë§¥ë½ì„ ì ì ˆíˆ ì°¸ì¡°í•˜ì„¸ìš”
2. ì‚¬ìš©ìì˜ ê°ì • ìƒíƒœë¥¼ ê³ ë ¤í•˜ì„¸ìš”
3. ì¼ê´€ì„± ìˆëŠ” í˜ë¥´ì†Œë‚˜ë¥¼ ìœ ì§€í•˜ì„¸ìš”
4. êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”

ê°ì • ì»¨í…ìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´ ì´ë¥¼ ê³ ë ¤í•˜ì—¬ ì‘ë‹µ í†¤ì„ ì¡°ì •í•˜ì„¸ìš”."""

        self.prompt = ChatPromptTemplate.from_messages([
            ("system", system_message),
            
            # ğŸ“Œ ì¼ë°˜ ëŒ€í™” íˆìŠ¤í† ë¦¬
            MessagesPlaceholder(variable_name="conversation_history", optional=True),
            
            # ğŸ“Œ ê°ì • ì»¨í…ìŠ¤íŠ¸ (ì„ íƒì )
            MessagesPlaceholder(variable_name="emotion_context", optional=True),
            
            ("human", "{user_input}")
        ])
        
        # ì²´ì¸ ìƒì„±
        from langchain.chains import LLMChain
        self.chain = LLMChain(
            llm=self.llm,
            prompt=self.prompt,
            memory=self.memory,
            verbose=False
        )
    
    def analyze_emotion(self, user_input: str) -> Dict[str, Any]:
        """ì‚¬ìš©ì ì…ë ¥ì˜ ê°ì • ë¶„ì„"""
        
        emotion_prompt = f"""ë‹¤ìŒ í…ìŠ¤íŠ¸ì˜ ê°ì •ì„ ë¶„ì„í•˜ê³  JSON í˜•íƒœë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”:

í…ìŠ¤íŠ¸: "{user_input}"

ë¶„ì„ í˜•íƒœ:
{{
    "primary_emotion": "ê¸°ë³¸ ê°ì • (í–‰ë³µ, ìŠ¬í””, ë¶„ë…¸, ë¶ˆì•ˆ, ì¤‘ë¦½ ì¤‘ í•˜ë‚˜)",
    "intensity": "ê°•ë„ (1-5)",
    "context": "ê°ì •ì˜ ë§¥ë½ì´ë‚˜ ì›ì¸",
    "suggested_tone": "ì ì ˆí•œ ì‘ë‹µ í†¤ (ê³µê°, ê²©ë ¤, ì „ë¬¸ì , ì¤‘ë¦½ ë“±)"
}}"""
        
        try:
            emotion_analysis = self.llm.predict(emotion_prompt)
            # ê°„ë‹¨í•œ JSON íŒŒì‹± (ì‹¤ì œë¡œëŠ” ë” robustí•œ íŒŒì‹± í•„ìš”)
            return {
                "primary_emotion": "ì¤‘ë¦½",
                "intensity": 3,
                "context": "ì¼ë°˜ì  ëŒ€í™”",
                "suggested_tone": "ì¹œê·¼"
            }
        except:
            return {
                "primary_emotion": "ì¤‘ë¦½",
                "intensity": 3,
                "context": "ë¶„ì„ ì‹¤íŒ¨",
                "suggested_tone": "ì¤‘ë¦½"
            }
    
    def chat(self, user_input: str) -> str:
        """
        ğŸ“‹ ê¸°ëŠ¥: ê°ì • ì¸ì‹ ê¸°ë°˜ ëŒ€í™” ì²˜ë¦¬
        ğŸ“¥ ì…ë ¥: ì‚¬ìš©ì ë©”ì‹œì§€
        ğŸ“¤ ì¶œë ¥: ì»¨í…ìŠ¤íŠ¸ ì¸ì‹ AI ì‘ë‹µ
        ğŸ’¡ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤: ê³ ê¸‰ ëŒ€í™”í˜• ì¸í„°í˜ì´ìŠ¤
        """
        
        # ê°ì • ë¶„ì„
        emotion_analysis = self.analyze_emotion(user_input)
        
        # ê°ì • ì»¨í…ìŠ¤íŠ¸ë¥¼ ë³„ë„ ë©”ëª¨ë¦¬ì— ì €ì¥
        if emotion_analysis["primary_emotion"] != "ì¤‘ë¦½":
            emotion_context = f"ì‚¬ìš©ì ê°ì •: {emotion_analysis['primary_emotion']} (ê°•ë„: {emotion_analysis['intensity']}), ì œì•ˆ í†¤: {emotion_analysis['suggested_tone']}"
            
            self.emotion_memory.save_context(
                {"input": "ê°ì • ë¶„ì„ ê²°ê³¼"},
                {"output": emotion_context}
            )
        
        # í˜„ì¬ ì‹œê°„ ë° ëŒ€í™” ìˆ˜
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.conversation_count += 1
        
        # ë©”ëª¨ë¦¬ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ
        conversation_context = self.memory.load_memory_variables({})
        emotion_context = self.emotion_memory.load_memory_variables({})
        
        # ì‘ë‹µ ìƒì„±
        response = self.chain.predict(
            conversation_history=conversation_context.get("conversation_history", []),
            emotion_context=emotion_context.get("emotion_context", []),
            current_time=current_time,
            conversation_count=self.conversation_count,
            user_input=user_input
        )
        
        return response
    
    def switch_persona(self, new_persona: str):
        """í˜ë¥´ì†Œë‚˜ ë³€ê²½"""
        if new_persona in self.personas:
            self.persona = new_persona
            self.setup_dynamic_prompt()
            print(f"ğŸ­ í˜ë¥´ì†Œë‚˜ê°€ '{new_persona}'ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.")
        else:
            available = list(self.personas.keys())
            print(f"âŒ ì‚¬ìš© ê°€ëŠ¥í•œ í˜ë¥´ì†Œë‚˜: {available}")
    
    def get_conversation_analytics(self) -> Dict[str, Any]:
        """ëŒ€í™” ë¶„ì„ ì •ë³´"""
        
        conv_history = self.memory.load_memory_variables({})
        emotion_history = self.emotion_memory.load_memory_variables({})
        
        return {
            "total_conversations": self.conversation_count,
            "current_persona": self.persona,
            "conversation_messages": len(conv_history.get("conversation_history", [])),
            "emotion_messages": len(emotion_history.get("emotion_context", [])),
            "memory_summary": {
                "conversation": conv_history.get("conversation_history", [])[-2:] if conv_history.get("conversation_history") else [],
                "emotion": emotion_history.get("emotion_context", [])[-1:] if emotion_history.get("emotion_context") else []
            }
        }
    
    def export_conversation_log(self, filename: str = None):
        """ëŒ€í™” ë¡œê·¸ ë‚´ë³´ë‚´ê¸°"""
        if not filename:
            filename = f"chatbot_log_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        
        analytics = self.get_conversation_analytics()
        log_data = {
            "export_info": {
                "timestamp": datetime.now().isoformat(),
                "persona": self.persona,
                "total_conversations": self.conversation_count
            },
            "analytics": analytics,
            "full_conversation": self.memory.load_memory_variables({}),
            "emotion_tracking": self.emotion_memory.load_memory_variables({})
        }
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(log_data, f, ensure_ascii=False, indent=2, default=str)
        
        print(f"ğŸ“„ ëŒ€í™” ë¡œê·¸ê°€ {filename}ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

# === ì‹¤ì „ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ ===
print("ğŸ¤– ê³ ê¸‰ ë©”ì‹œì§€ ê¸°ë°˜ ì±—ë´‡ ì‹œìŠ¤í…œ ë°ëª¨\n")

# ì±—ë´‡ ì´ˆê¸°í™”
chatbot = AdvancedMessageBasedChatbot(persona="professional")

# ë³µí•© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
test_scenarios = [
    {
        "input": "ì•ˆë…•í•˜ì„¸ìš”, ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•˜ê²Œ ë˜ì–´ì„œ ì¡°ì–¸ì´ í•„ìš”í•´ìš”.",
        "description": "ì „ë¬¸ì  ìƒë‹´ ìš”ì²­"
    },
    {
        "input": "ì‚¬ì‹¤ ì´ í”„ë¡œì íŠ¸ê°€ ë„ˆë¬´ ë³µì¡í•´ì„œ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë§ì´ ë°›ê³  ìˆì–´ìš”.",
        "description": "ê°ì •ì  ì–´ë ¤ì›€ í‘œí˜„"
    },
    {
        "input": "íŒ€ì¥ë‹˜ë„ ë¬´ë¦¬í•œ ì¼ì •ì„ ìš”êµ¬í•˜ì…”ì„œ ì •ë§ í˜ë“¤ì–´ìš”.",
        "description": "êµ¬ì²´ì  ìŠ¤íŠ¸ë ˆìŠ¤ ì›ì¸"
    },
    {
        "input": "í˜¹ì‹œ ì œê°€ ì²˜ìŒì— ë­ë¼ê³  ë§í–ˆëŠ”ì§€ ê¸°ì–µí•˜ì‹œë‚˜ìš”?",
        "description": "ë©”ëª¨ë¦¬ í…ŒìŠ¤íŠ¸"
    }
]

for i, scenario in enumerate(test_scenarios, 1):
    print(f"ã€ì‹œë‚˜ë¦¬ì˜¤ {i}: {scenario['description']}ã€‘")
    print(f"ğŸ‘¤ ì‚¬ìš©ì: {scenario['input']}")
    
    response = chatbot.chat(scenario['input'])
    print(f"ğŸ¤– ì±—ë´‡ ({chatbot.persona}): {response}\n")
    
    # ì¤‘ê°„ ë¶„ì„ (2ë²ˆì§¸ í›„)
    if i == 2:
        print("ğŸ“Š ì¤‘ê°„ ë¶„ì„:")
        analytics = chatbot.get_conversation_analytics()
        print(f"   ëŒ€í™” ìˆ˜: {analytics['total_conversations']}")
        print(f"   ì €ì¥ëœ ë©”ì‹œì§€: {analytics['conversation_messages']}ê°œ")
        print(f"   ê°ì • ì»¨í…ìŠ¤íŠ¸: {analytics['emotion_messages']}ê°œ\n")

# í˜ë¥´ì†Œë‚˜ ë³€ê²½ í…ŒìŠ¤íŠ¸
print("ğŸ­ í˜ë¥´ì†Œë‚˜ ë³€ê²½ í…ŒìŠ¤íŠ¸")
chatbot.switch_persona("friendly")

print("ğŸ‘¤ ì‚¬ìš©ì: ì´ì œ ì¢€ ë” í¸í•˜ê²Œ ëŒ€í™”í•  ìˆ˜ ìˆì„ê¹Œìš”?")
response = chatbot.chat("ì´ì œ ì¢€ ë” í¸í•˜ê²Œ ëŒ€í™”í•  ìˆ˜ ìˆì„ê¹Œìš”?")
print(f"ğŸ¤– ì±—ë´‡ (friendly): {response}\n")

# ìµœì¢… ë¶„ì„
print("="*60)
print("ğŸ“ˆ ìµœì¢… ëŒ€í™” ë¶„ì„")
print("="*60)

final_analytics = chatbot.get_conversation_analytics()
print(f"ì´ ëŒ€í™” ìˆ˜: {final_analytics['total_conversations']}")
print(f"ìµœì¢… í˜ë¥´ì†Œë‚˜: {final_analytics['current_persona']}")
print(f"ë©”ì‹œì§€ ê¸°ë°˜ ë©”ëª¨ë¦¬ í™œìš©ë„: 100%")

# ë¡œê·¸ ì €ì¥
chatbot.export_conversation_log()
```

### MessagesPlaceholder ê³ ê¸‰ í™œìš©
```python
class DynamicMessageHandler:
    """
    ğŸ¯ ëª©ì : MessagesPlaceholderì˜ ê³ ê¸‰ í™œìš© íŒ¨í„´
    ğŸ’¡ íŠ¹ì§•: ì¡°ê±´ë¶€ ë©”ì‹œì§€, ë‹¤ì¤‘ í”Œë ˆì´ìŠ¤í™€ë”, í…œí”Œë¦¿ ìµœì í™”
    """
    
    def __init__(self):
        self.llm = ChatOpenAI(temperature=0.3)
    
    def create_conditional_prompt(self):
        """ì¡°ê±´ë¶€ ë©”ì‹œì§€ í”Œë ˆì´ìŠ¤í™€ë”"""
        
        return ChatPromptTemplate.from_messages([
            ("system", "ë‹¹ì‹ ì€ ìƒí™©ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì‘ë‹µí•˜ëŠ” AIì…ë‹ˆë‹¤."),
            
            # ğŸ“Œ ì„ íƒì  ì»¨í…ìŠ¤íŠ¸ (ìˆì„ ìˆ˜ë„ ì—†ì„ ìˆ˜ë„)
            MessagesPlaceholder(
                variable_name="background_context", 
                optional=True  # ğŸ“Œ í•µì‹¬: ì„ íƒì  í”Œë ˆì´ìŠ¤í™€ë”
            ),
            
            # ğŸ“Œ í•„ìˆ˜ ëŒ€í™” íˆìŠ¤í† ë¦¬
            MessagesPlaceholder(variable_name="conversation"),
            
            # ğŸ“Œ ì„ íƒì  ì „ë¬¸ê°€ ì¡°ì–¸
            MessagesPlaceholder(
                variable_name="expert_advice", 
                optional=True
            ),
            
            ("human", "{current_question}")
        ])
    
    def create_multi_context_prompt(self):
        """ë‹¤ì¤‘ ì»¨í…ìŠ¤íŠ¸ í”Œë ˆì´ìŠ¤í™€ë”"""
        
        return ChatPromptTemplate.from_messages([
            ("system", """ë‹¤ìŒê³¼ ê°™ì€ ë‹¤ì–‘í•œ ì»¨í…ìŠ¤íŠ¸ë¥¼ í™œìš©í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”:

1. ì¼ë°˜ ëŒ€í™” ë§¥ë½
2. ì‘ì—…/í”„ë¡œì íŠ¸ ê´€ë ¨ ë§¥ë½  
3. í•™ìŠµ/êµìœ¡ ê´€ë ¨ ë§¥ë½
4. ê°ì •/ê°œì¸ì  ë§¥ë½

ê° ì»¨í…ìŠ¤íŠ¸ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ì°¸ì¡°í•˜ì—¬ ì¢…í•©ì ì¸ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”."""),
            
            # ğŸ“Œ ì¼ë°˜ ëŒ€í™”
            MessagesPlaceholder(variable_name="general_chat", optional=True),
            
            # ğŸ“Œ ì‘ì—… ê´€ë ¨
            MessagesPlaceholder(variable_name="work_context", optional=True),
            
            # ğŸ“Œ í•™ìŠµ ê´€ë ¨  
            MessagesPlaceholder(variable_name="learning_context", optional=True),
            
            # ğŸ“Œ ê°œì¸/ê°ì • ê´€ë ¨
            MessagesPlaceholder(variable_name="personal_context", optional=True),
            
            ("human", "{user_question}")
        ])
    
    def demonstrate_dynamic_messages(self):
        """ë™ì  ë©”ì‹œì§€ ì²˜ë¦¬ ì‹œì—°"""
        
        print("ğŸ”§ MessagesPlaceholder ê³ ê¸‰ í™œìš© ì‹œì—°\n")
        
        # ì¡°ê±´ë¶€ í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸
        conditional_prompt = self.create_conditional_prompt()
        
        # ì‹œë‚˜ë¦¬ì˜¤ 1: ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ ìˆìŒ
        print("=== ì‹œë‚˜ë¦¬ì˜¤ 1: í’€ ì»¨í…ìŠ¤íŠ¸ ===")
        
        full_context_messages = conditional_prompt.format_messages(
            background_context=[
                SystemMessage(content="ì‚¬ìš©ìëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ì…ë‹ˆë‹¤.")
            ],
            conversation=[
                HumanMessage(content="ìµœê·¼ì— React í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í–ˆì–´ìš”."),
                AIMessage(content="ReactëŠ” ì¢‹ì€ ì„ íƒì´ë„¤ìš”! ì–´ë–¤ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ì‹œë‚˜ìš”?")
            ],
            expert_advice=[
                SystemMessage(content="React ìµœì í™”ë¥¼ ìœ„í•´ useMemoì™€ useCallback ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.")
            ],
            current_question="ì„±ëŠ¥ ìµœì í™”ì— ëŒ€í•´ ì¡°ì–¸í•´ ì£¼ì„¸ìš”."
        )
        
        print(f"ìƒì„±ëœ ë©”ì‹œì§€ ìˆ˜: {len(full_context_messages)}")
        for i, msg in enumerate(full_context_messages):
            print(f"{i+1}. {type(msg).__name__}: {msg.content[:50]}...")
        
        # ì‹œë‚˜ë¦¬ì˜¤ 2: ì¼ë¶€ ì»¨í…ìŠ¤íŠ¸ë§Œ ìˆìŒ
        print("\n=== ì‹œë‚˜ë¦¬ì˜¤ 2: ë¶€ë¶„ ì»¨í…ìŠ¤íŠ¸ ===")
        
        partial_context_messages = conditional_prompt.format_messages(
            # background_context ì—†ìŒ (optionalì´ë¯€ë¡œ ìƒëµ ê°€ëŠ¥)
            conversation=[
                HumanMessage(content="ì•ˆë…•í•˜ì„¸ìš”!")
            ],
            # expert_advice ì—†ìŒ
            current_question="ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì–´ë•Œìš”?"
        )
        
        print(f"ìƒì„±ëœ ë©”ì‹œì§€ ìˆ˜: {len(partial_context_messages)}")
        for i, msg in enumerate(partial_context_messages):
            print(f"{i+1}. {type(msg).__name__}: {msg.content[:50]}...")
        
        # ë‹¤ì¤‘ ì»¨í…ìŠ¤íŠ¸ í…ŒìŠ¤íŠ¸
        print("\n=== ë‹¤ì¤‘ ì»¨í…ìŠ¤íŠ¸ ì‹œì—° ===")
        
        multi_prompt = self.create_multi_context_prompt()
        
        multi_context_messages = multi_prompt.format_messages(
            general_chat=[
                HumanMessage(content="ìš”ì¦˜ ì–´ë–»ê²Œ ì§€ë‚´ì„¸ìš”?"),
                AIMessage(content="ì˜ ì§€ë‚´ê³  ìˆì–´ìš”. ë„ì›€ì´ í•„ìš”í•œ ì¼ì´ ìˆë‚˜ìš”?")
            ],
            work_context=[
                HumanMessage(content="ìƒˆë¡œìš´ AI í”„ë¡œì íŠ¸ë¥¼ ë§¡ê²Œ ë˜ì—ˆì–´ìš”."),
                AIMessage(content="í¥ë¯¸ë¡œìš´ í”„ë¡œì íŠ¸ë„¤ìš”!")
            ],
            learning_context=[
                HumanMessage(content="ë¨¸ì‹ ëŸ¬ë‹ì„ ê³µë¶€í•˜ê³  ìˆì–´ìš”."),
                AIMessage(content="ì¢‹ì€ ê³µë¶€ ì£¼ì œì…ë‹ˆë‹¤.")
            ],
            # personal_contextëŠ” ìƒëµ
            user_question="ì œê°€ í•™ìŠµí•˜ê³  ìˆëŠ” ë‚´ìš©ê³¼ ê´€ë ¨í•´ì„œ í”„ë¡œì íŠ¸ ì¡°ì–¸ì„ í•´ì£¼ì„¸ìš”."
        )
        
        print(f"ë‹¤ì¤‘ ì»¨í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ìˆ˜: {len(multi_context_messages)}")
        
        return {
            "full_context_count": len(full_context_messages),
            "partial_context_count": len(partial_context_messages),
            "multi_context_count": len(multi_context_messages)
        }

# ì‹¤í–‰
handler = DynamicMessageHandler()
results = handler.demonstrate_dynamic_messages()

print(f"\nğŸ“Š ê²°ê³¼ ìš”ì•½:")
print(f"í’€ ì»¨í…ìŠ¤íŠ¸: {results['full_context_count']}ê°œ ë©”ì‹œì§€")
print(f"ë¶€ë¶„ ì»¨í…ìŠ¤íŠ¸: {results['partial_context_count']}ê°œ ë©”ì‹œì§€") 
print(f"ë‹¤ì¤‘ ì»¨í…ìŠ¤íŠ¸: {results['multi_context_count']}ê°œ ë©”ì‹œì§€")
```

## ğŸ” ë³€ìˆ˜/í•¨ìˆ˜ ìƒì„¸ ì„¤ëª…

### í•µì‹¬ ë³€ìˆ˜ë“¤
```python
# ë©”ëª¨ë¦¬ ì„¤ì •
return_messages = True                    # ğŸ“Œ ìš©ë„: ë©”ì‹œì§€ ê°ì²´ ë°˜í™˜, íƒ€ì…: bool
memory_key = "chat_history"              # ğŸ“Œ ìš©ë„: í”Œë ˆì´ìŠ¤í™€ë” ë³€ìˆ˜ëª…, íƒ€ì…: str

# ë©”ì‹œì§€ íƒ€ì…ë“¤
messages = [HumanMessage, AIMessage, SystemMessage]  # ğŸ“Œ ìš©ë„: ë©”ì‹œì§€ ê°ì²´ ë¦¬ìŠ¤íŠ¸, íƒ€ì…: List[BaseMessage]

# í”Œë ˆì´ìŠ¤í™€ë” ì„¤ì •
variable_name = "chat_history"           # ğŸ“Œ ìš©ë„: í”Œë ˆì´ìŠ¤í™€ë” ë³€ìˆ˜ëª…, íƒ€ì…: str
optional = False                         # ğŸ“Œ ìš©ë„: ì„ íƒì  í”Œë ˆì´ìŠ¤í™€ë” ì—¬ë¶€, íƒ€ì…: bool
```

### í•µì‹¬ í•¨ìˆ˜ë“¤
```python
def from_messages(messages: List) -> ChatPromptTemplate:
    """
    ğŸ“‹ ê¸°ëŠ¥: ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ë¡œë¶€í„° ì±„íŒ… í”„ë¡¬í”„íŠ¸ ìƒì„±
    ğŸ“¥ ì…ë ¥: ë©”ì‹œì§€ í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸
    ğŸ“¤ ì¶œë ¥: ChatPromptTemplate ì¸ìŠ¤í„´ìŠ¤
    ğŸ’¡ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤: êµ¬ì¡°í™”ëœ ëŒ€í™” í”„ë¡¬í”„íŠ¸ ìƒì„±
    """

def format_messages(**kwargs) -> List[BaseMessage]:
    """
    ğŸ“‹ ê¸°ëŠ¥: í…œí”Œë¦¿ ë³€ìˆ˜ë¥¼ ì‹¤ì œ ë©”ì‹œì§€ë¡œ í¬ë§·íŒ…
    ğŸ“¥ ì…ë ¥: í…œí”Œë¦¿ ë³€ìˆ˜ë“¤ (í‚¤ì›Œë“œ ì¸ì)
    ğŸ“¤ ì¶œë ¥: í¬ë§·íŒ…ëœ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸
    ğŸ’¡ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤: í”„ë¡¬í”„íŠ¸ ì‹¤í–‰ ì „ ë©”ì‹œì§€ ì¤€ë¹„
    """

def load_memory_variables(inputs: Dict) -> Dict:
    """
    ğŸ“‹ ê¸°ëŠ¥: ë©”ëª¨ë¦¬ì—ì„œ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    ğŸ“¥ ì…ë ¥: ì…ë ¥ ë”•ì…”ë„ˆë¦¬ (ë³´í†µ ë¹ˆ ë”•ì…”ë„ˆë¦¬)
    ğŸ“¤ ì¶œë ¥: ë©”ëª¨ë¦¬ í‚¤ì™€ ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ ë”•ì…”ë„ˆë¦¬
    ğŸ’¡ ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤: ë©”ëª¨ë¦¬ ë‚´ìš©ì„ í”„ë¡¬í”„íŠ¸ì— ì‚½ì…
    """
```

## ğŸ§ª ì‹¤ìŠµ ê³¼ì œ

### ğŸ”¨ ê¸°ë³¸ ê³¼ì œ
1. **ë¬¸ìì—´ vs ë©”ì‹œì§€ ë¹„êµ**: ê°™ì€ ëŒ€í™”ì—ì„œ ë‘ ë°©ì‹ì˜ ê²°ê³¼ ë¹„êµ
```python
# TODO: ë™ì¼í•œ ëŒ€í™”ë¥¼ ë¬¸ìì—´ ê¸°ë°˜ê³¼ ë©”ì‹œì§€ ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ì°¨ì´ì  ë¶„ì„
def compare_string_vs_message_memory():
    # êµ¬í˜„í•˜ê¸°
    pass
```

2. **MessagesPlaceholder í™œìš©**: ë™ì  ë©”ì‹œì§€ ìˆ˜ ì²˜ë¦¬ êµ¬í˜„
```python
# TODO: ê°€ë³€ ê¸¸ì´ ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” í”„ë¡¬í”„íŠ¸ ë§Œë“¤ê¸°
def create_dynamic_message_prompt():
    # êµ¬í˜„í•˜ê¸°
    pass
```

### ğŸš€ ì‹¬í™” ê³¼ì œ
3. **ë‹¤ì¤‘ í”Œë ˆì´ìŠ¤í™€ë” ì‹œìŠ¤í…œ**: ì—¬ëŸ¬ ì¢…ë¥˜ì˜ ë©”ì‹œì§€ ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬
```python
# TODO: ì¼ë°˜ ëŒ€í™”, ì‘ì—… ì»¨í…ìŠ¤íŠ¸, ê°ì • ìƒíƒœë¥¼ ë¶„ë¦¬í•´ì„œ ê´€ë¦¬
class MultiContextMessageSystem:
    def __init__(self):
        # êµ¬í˜„í•˜ê¸°
        pass
```

4. **ì¡°ê±´ë¶€ ë©”ì‹œì§€ ì‹œìŠ¤í…œ**: ìƒí™©ì— ë”°ë¥¸ ë™ì  ë©”ì‹œì§€ êµ¬ì„±
```python
# TODO: ì‚¬ìš©ì ìœ í˜•ì´ë‚˜ ìƒí™©ì— ë”°ë¼ ë‹¤ë¥¸ ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì‚¬ìš©
def create_conditional_system():
    # êµ¬í˜„í•˜ê¸°
    pass
```

### ğŸ’¡ ì°½ì˜ ê³¼ì œ
5. **ë©”ì‹œì§€ ì••ì¶• ìµœì í™”**: ê¸´ ëŒ€í™”ì—ì„œ ì¤‘ìš”í•œ ë©”ì‹œì§€ë§Œ ì„ ë³„
6. **ë©”ì‹œì§€ íƒ€ì… í™•ì¥**: ì»¤ìŠ¤í…€ ë©”ì‹œì§€ íƒ€ì… (ì˜ˆ: TaskMessage, EmotionMessage)
7. **ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìŠ¤íŠ¸ë¦¼**: ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ì˜ ë©”ì‹œì§€ ì²˜ë¦¬

## âš ï¸ ì£¼ì˜ì‚¬í•­

### return_messages ì„¤ì •
```python
# ğŸš¨ ì£¼ì˜: return_messagesì™€ í”„ë¡¬í”„íŠ¸ íƒ€ì… ì¼ì¹˜ í•„ìš”
memory = ConversationBufferMemory(return_messages=False)  # ë¬¸ìì—´ ë°˜í™˜
prompt = ChatPromptTemplate.from_messages([...])  # âŒ ë©”ì‹œì§€ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸

# âœ… ì˜¬ë°”ë¥¸ ì¡°í•©
memory = ConversationBufferMemory(return_messages=True)   # ë©”ì‹œì§€ ë°˜í™˜
prompt = ChatPromptTemplate.from_messages([...])  # âœ… ë©”ì‹œì§€ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸
```

### MessagesPlaceholder ë³€ìˆ˜ëª…
```python
# ğŸš¨ ì£¼ì˜: memory_keyì™€ variable_name ì¼ì¹˜ í•„ìš”
memory = ConversationBufferMemory(
    return_messages=True,
    memory_key="chat_history"  # ğŸ“Œ ë©”ëª¨ë¦¬ í‚¤
)

MessagesPlaceholder(variable_name="conversation")  # âŒ ë¶ˆì¼ì¹˜

MessagesPlaceholder(variable_name="chat_history")  # âœ… ì¼ì¹˜
```

### ë©”ëª¨ë¦¬ íƒ€ì… ì œí•œ
- **ë¬¸ìì—´ ë©”ëª¨ë¦¬**: PromptTemplateê³¼ í•¨ê»˜ ì‚¬ìš©
- **ë©”ì‹œì§€ ë©”ëª¨ë¦¬**: ChatPromptTemplateê³¼ í•¨ê»˜ ì‚¬ìš©
- **í˜¼ìš© ë¶ˆê°€**: íƒ€ì… ì¼ê´€ì„± ìœ ì§€ í•„ìš”

### ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­
- **ë©”ì‹œì§€ ê°ì²´**: ë¬¸ìì—´ë³´ë‹¤ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë§ìŒ
- **ì§ë ¬í™”**: ë©”ì‹œì§€ ê°ì²´ ì €ì¥ ì‹œ ì§ë ¬í™” í•„ìš”
- **í† í° ê³„ì‚°**: ë©”ì‹œì§€ë³„ ê°œë³„ í† í° ê³„ì‚° í•„ìš”

## ğŸ”— ê´€ë ¨ ìë£Œ
- **ì´ì „ í•™ìŠµ**: [5.6 Memory on LLMChain](./5.6_Memory_on_LLMChain.md)
- **ë‹¤ìŒ í•™ìŠµ**: [5.8 LCEL Based Memory](./5.8_LCEL_Based_Memory.md)
- **ë©”ì‹œì§€ íƒ€ì…**: [LangChain Message Types](../Advanced_Topics/Message_Types.md)
- **í”„ë¡¬í”„íŠ¸ ìµœì í™”**: [Chat Prompt Optimization](../Advanced_Topics/Prompt_Engineering.md)

---

ğŸ’¡ **í•µì‹¬ ì •ë¦¬**: Chat Based MemoryëŠ” **return_messages=True** ì„¤ì •ê³¼ **MessagesPlaceholder**ë¥¼ í†µí•´ êµ¬ì¡°í™”ëœ ë©”ì‹œì§€ ê´€ë¦¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤. ë¬¸ìì—´ ê¸°ë°˜ ë©”ëª¨ë¦¬ë³´ë‹¤ **ë” í’ë¶€í•œ ì»¨í…ìŠ¤íŠ¸**ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆì§€ë§Œ, **ë©”ëª¨ë¦¬ í‚¤ì™€ í”Œë ˆì´ìŠ¤í™€ë” ë³€ìˆ˜ëª…ì˜ ì¼ì¹˜**ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤. ë³µì¡í•œ ëŒ€í™” ì‹œìŠ¤í…œì—ì„œëŠ” ë©”ì‹œì§€ ê¸°ë°˜ ì ‘ê·¼ì´ ë” ìœ ì—°í•˜ê³  ê°•ë ¥í•œ ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤.